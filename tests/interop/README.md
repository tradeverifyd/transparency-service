# Go tlog Interoperability Tests

This directory contains cross-implementation tests to ensure compatibility between our TypeScript implementation and the canonical Go implementation from `golang.org/x/mod/sumdb/tlog`.

## Structure

```
tests/interop/
├── README.md                    # This file
├── go-tlog-generator/          # Go program to generate test vectors
│   ├── go.mod
│   ├── go.sum
│   └── main.go
├── test-vectors/               # JSON test vectors generated by Go
│   ├── tlog-size-2.json
│   ├── tlog-size-4.json
│   ├── tlog-size-7.json
│   ├── tlog-size-8.json
│   └── tlog-size-16.json
└── go-interop.test.ts          # TypeScript tests using the vectors
```

## Test Vectors

Test vectors are generated using the Go implementation and contain:

- **leaves**: Raw leaf data (32 bytes, hex-encoded)
- **root**: Expected tree root hash (hex-encoded)
- **inclusionProofs**: Inclusion proofs for each leaf
  - `leafIndex`: Index of the leaf
  - `auditPath`: Array of hashes forming the proof (hex-encoded)

### Example Test Vector

```json
{
  "treeSize": 4,
  "leaves": ["0000...", "0101...", "0202...", "0303..."],
  "root": "fdea5200...",
  "inclusionProofs": [
    {
      "leafIndex": 0,
      "auditPath": ["dcffe786...", "fc264939..."]
    }
    // ... more proofs
  ]
}
```

## Regenerating Test Vectors

To regenerate test vectors using the latest Go implementation:

```bash
cd tests/interop/go-tlog-generator
go run main.go
```

This will update all JSON files in `test-vectors/`.

## Running Interop Tests

Run the TypeScript interop tests:

```bash
bun test tests/interop/go-interop.test.ts
```

## What These Tests Verify

For each tree size (2, 4, 7, 8, 16), the tests verify:

1. **Root Hash Compatibility**: TypeScript implementation computes the same root hash as Go
2. **Proof Generation**: TypeScript generates identical inclusion proofs to Go
3. **Proof Verification**: TypeScript can verify Go-generated proofs
4. **Cross-Validation**: Go proofs verify against TypeScript-computed roots

All 20 tests (5 tree sizes × 4 tests) pass, confirming full compatibility.

## RFC 6962 Compliance

Both implementations follow [RFC 6962](https://tools.ietf.org/html/rfc6962) for:

- Leaf hashing: `SHA256(0x00 || leaf_data)`
- Node hashing: `SHA256(0x01 || left_hash || right_hash)`
- Tree structure: k-based splitting (left-biased, not complete binary tree)
- Audit path ordering: Leaf-to-root

## Test Coverage

The test vectors include edge cases:

- **Size 2**: Minimum non-trivial tree
- **Size 4**: Power of 2, fully balanced
- **Size 7**: Non-power of 2, tests edge cases
- **Size 8**: Power of 2, 3 levels
- **Size 16**: Larger power of 2

Each size tests all possible leaf indices, ensuring comprehensive coverage.
