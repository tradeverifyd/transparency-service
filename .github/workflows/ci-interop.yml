name: CI - Interoperability

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  interop-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install TypeScript dependencies
        working-directory: ./scitt-typescript
        run: bun install

      - name: Build Go CLI binary
        working-directory: ./scitt-golang
        run: |
          go build -v -o scitt ./cmd/scitt
          chmod +x scitt
          ./scitt --version || echo "Go CLI built successfully"

      - name: Build implementations
        working-directory: ./tests/interop
        run: ./scripts/build_impls.sh

      - name: Run interoperability tests
        working-directory: ./tests/interop
        run: |
          echo "Running integration test suite..."
          go test -v -parallel 10 ./...
        env:
          SCITT_GO_CLI: ${{ github.workspace }}/scitt-golang/scitt
          SCITT_TS_CLI: "bun run ${{ github.workspace }}/scitt-typescript/src/cli/index.ts"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.os }}
          path: |
            tests/interop/**/*.log
            tests/interop/test-results.json
          retention-days: 30

      - name: Generate test report
        if: always()
        working-directory: ./tests/interop
        run: |
          go test -json ./... > test-results.json 2>&1 || true
          echo "Test results saved to test-results.json"
